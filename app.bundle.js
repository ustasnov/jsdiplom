!function(){"use strict";class e{constructor(e,t,a){this.row=e,this.column=t,this.boardSize=a}static byIndex(e,t){return new this(Math.floor(e/t),(e+t)%t,t)}get index(){return this.row*this.boardSize+this.column}}function t(t,a){const s=e.byIndex(t,a),i=a-1;return 0===s.column?0===s.row?"top-left":s.row===i?"bottom-left":"left":s.column===i?0===s.row?"top-right":s.row===i?"bottom-right":"right":0===s.row?"top":s.row===i?"bottom":"center"}function a(e){return parseInt(Math.round(e).toFixed(0),10)}class s{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>\n        <button data-id="action-save" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É</button>\n        <button data-id="action-load" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${t(e,this.boardSize)}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var i={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class r{constructor(e,t="generic",a=0){if(this.level=e,this.teamId=a,this.attack=0,this.defence=0,this.health=50,this.type=t,this.id=-1,"Character"===new.target.name)throw new Error("You cannot instantiate this class!")}getTooltip(){return`üéñ ${this.level} ‚öî ${this.attack} üõ° ${this.defence} ‚ù§ ${this.health}`}increaseLevel(e){for(let t=this.level;t<e;t+=1)this.attack=Math.max(this.attack,a((80+this.health)*(this.attack/100))),this.defence=Math.max(this.defence,a((80+this.health)*(this.defence/100))),this.level+=1,this.health=Math.min(this.health+80,100)}}class n extends r{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25,this.distance=2,this.attackDistance=2}}class c extends r{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10,this.distance=4,this.attackDistance=1}}class l extends r{constructor(e){super(e,"magician"),this.attack=10,this.defence=40,this.distance=1,this.attackDistance=4}}class h extends r{constructor(e){super(e,"vampire"),this.attack=25,this.defence=25,this.distance=2,this.attackDistance=2}}class o extends r{constructor(e){super(e,"undead"),this.attack=40,this.defence=10,this.distance=4,this.attackDistance=1}}class d extends r{constructor(e){super(e,"daemon"),this.attack=10,this.defence=10,this.distance=1,this.attackDistance=4}}class m{constructor(e,t){if(!(e instanceof r))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}static restore(e,t){const a=Array.from(t.characters).find((t=>t.id===e.character.id));return new m(a,e.position)}}var g="pointer",u="crosshair",p="not-allowed";function f(e,t){const a=e+Math.random()*(t+1-e);return Math.floor(a)}const S={bowman:n,swordsman:c,magician:l,vampire:h,undead:o,daemon:d};class v{constructor(e=0){this.id=e,this.characters=[]}has(e){return Array.from(this.characters).includes(e)}increaseCharactersLevel(){Array.from(this.characters).forEach((e=>e.increaseLevel(e.level+1)))}static create(e,t,a,s){const i=new v(e),r=function*(e,t){for(;;){const a=f(0,e.length-1),s=f(1,t),i=new e[a](1);i.increaseLevel(s),yield i}}(t,a);for(let t=0;t<s;t+=1){const a=r.next().value;a.teamId=e,a.id=t,i.characters.push(a)}return i}static restoreCharacter(e){const t=new S[e.type](1);return Object.assign(t,e),t}static restore(e){const t=new v(e.id);return t.characters=Array.from(e.characters).map((e=>v.restoreCharacter(e))),t}}class C{constructor(){this.teams=[null,null],this.score=[0,0],this.gameRound=0,this.playerTurn=!0,this.playerAlive=4,this.rivalAlive=4,this.positionedCharacters=[],this.selectedIndex=-1}static from(e){const t=new C;t.score=e.score,t.gameRound=e.gameRound,t.playerTurn=!0,t.playerAlive=e.playerAlive,t.rivalAlive=e.rivalAlive,t.selectedIndex=e.selectedIndex;for(let a=0;a<t.teams.length;a+=1)t.teams[a]=v.restore(e.teams[a]);return t.positionedCharacters=Array.from(e.positionedCharacters).map((e=>m.restore(e,t.teams[e.character.teamId]))),t}}const w=new s;w.bindToDOM(document.querySelector("#game-container"));const y=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),x=new class{constructor(e,t){this.characterCount=4,this.gamePlay=e,this.stateService=t,this.rounds=4,this.selectedGreenIndex=-1,this.selectedRedIndex=-1,this.cellsForMove=[],this.cellsForAttack=[],this.gameState=new C,this.chractersTypes=[[n,c,l],[h,o,d]]}get theme(){let e=Object.values(i)[this.gameState.gameRound-1];return e||(e=i.prairie),e}placeTeam(t){const a=this.gamePlay.boardSize,s=2*a,i=[],r=[0,1];t===this.gameState.teams[1]&&(r[0]=a-2,r[1]=a-1),Array.from(t.characters).forEach((t=>{let n=f(0,s-1);for(;i.indexOf(n)>-1;)n=f(0,s-1);i.push(n);const c=n<a?new e(n,r[0],a).index:new e(n-a,r[1],a).index;this.gameState.positionedCharacters.push(new m(t,c))}))}addListeners(){this.gamePlay.addNewGameListener(this.onNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGame.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGame.bind(this)),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this))}clearButtonsListeners(){this.gamePlay.newGameListeners=[],this.gamePlay.saveGameListeners=[],this.gamePlay.loadGameListeners=[]}clearMouseListeners(){this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[]}init(){this.gameState.gameRound=0,this.gameState.score[0]=0,this.gameState.score[1]=0;for(let e=0;e<this.gameState.teams.length;e+=1)this.gameState.teams[e]=v.create(e,this.chractersTypes[e],2,this.characterCount);this.startRound(),this.addListeners()}gameOver(e=!0){return!e&&!confirm("–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É?")||(this.gameState.selectedIndex>-1&&(this.gamePlay.deselectCell(this.gameState.selectedIndex),this.gameState.selectedIndex=-1),this.gameState.positionedCharacters=[],this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.clearMouseListeners(),setTimeout((()=>{e?this.gameState.score[0]>this.gameState.score[1]?s.showMessage(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞: –≤—ã –≤—ã–∏–≥—Ä–∞–ª–∏. –û–±—â–∏–π —Å—á–µ—Ç ${this.gameState.score[0]}:${this.gameState.score[1]}`):s.showMessage(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞: –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–≥–∏. –û–±—â–∏–π —Å—á–µ—Ç ${this.gameStateis.score[0]}:${this.gameState.score[1]}`):(this.clearButtonsListeners(),this.init())}),200),!0)}startRound(){this.gameState.gameRound+=1,this.gameState.playerTurn=!0,this.gameState.playerAlive=4,this.gameState.rivalAlive=4,this.gameState.positionedCharacters=[],this.gamePlay.drawUi(this.theme);for(let e=0;e<this.gameState.teams.length;e+=1)this.placeTeam(this.gameState.teams[e]);this.gamePlay.redrawPositions(this.gameState.positionedCharacters)}nextRound(){this.gameState.score[this.gameState.positionedCharacters[0].character.teamId]+=1;const e=0===this.gameState.positionedCharacters[0].character.teamId;if(this.gameState.gameRound===this.rounds)this.gameOver();else{for(let e=0;e<this.gameState.teams.length;e+=1)this.gameState.teams[e].increaseCharactersLevel();this.gameState.selectedIndex>-1&&(this.gamePlay.deselectCell(this.gameState.selectedIndex),this.gameState.selectedIndex=-1),this.gameState.positionedCharacters=[],this.gamePlay.redrawPositions(this.gameState.positionedCharacters),setTimeout((()=>{e?s.showMessage(`–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ —ç—Ç–æ—Ç —Ä–∞—É–Ω–¥. –û–±—â–∏–π —Å—á–µ—Ç ${this.gameState.score[0]}:${this.gameState.score[1]}`):s.showMessage(`–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ —ç—Ç–æ—Ç —Ä–∞—É–Ω–¥. –û–±—â–∏–π —Å—á–µ—Ç ${this.gameState.score[0]}:${this.gameState.score[1]}`),this.startRound()}),200)}}getCellsForMove(t){const a=function(t,a){const s=[],i=e.byIndex(t.position,a),r=new e(i.row,i.column,a),n=Math.min(i.column+t.character.distance,a-1),c=Math.max(i.column-t.character.distance,0),l=Math.min(i.row+t.character.distance,a-1),h=Math.max(i.row-t.character.distance,0);for(let e=1;e<=t.character.distance;e+=1){const t=i.column+e,a=i.row+e,o=i.column-e,d=i.row-e;t<=n&&(r.row=i.row,r.column=t,s.push(r.index)),o>=c&&(r.row=i.row,r.column=o,s.push(r.index)),d>=h&&(r.column=i.column,r.row=d,s.push(r.index)),a<=l&&(r.column=i.column,r.row=a,s.push(r.index)),t<=n&&d>=h&&(r.row=d,r.column=t,s.push(r.index)),o>=c&&d>=h&&(r.row=d,r.column=o,s.push(r.index)),o>=c&&a<=l&&(r.column=o,r.row=a,s.push(r.index)),t<=n&&a<=l&&(r.row=a,r.column=t,s.push(r.index))}return s}(t,this.gamePlay.boardSize);this.cellsForMove=a.filter((e=>void 0===Array.from(this.gameState.positionedCharacters).find((t=>t.position===e))))}getCellsForAttack(t){this.cellsForAttack=function(t,a){const s=[],i=e.byIndex(t.position,a),r=new e(i.row,i.column,a),n=Math.min(i.column+t.character.attackDistance,a-1),c=Math.max(i.column-t.character.attackDistance,0),l=Math.min(i.row+t.character.attackDistance,a-1);for(let e=Math.max(i.row-t.character.attackDistance,0);e<=l;e+=1)for(let t=c;t<=n;t+=1)r.row=e,r.column=t,s.push(r.index);return s}(t,this.gamePlay.boardSize)}moveCharacter(e,t){Array.from(this.gameState.positionedCharacters).find((t=>t.position===e)).position=t,this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.onCellClick(t),this.passMove()}attack(e,t){const s=Array.from(this.gameState.positionedCharacters).find((e=>e.position===t)),i=a(Math.max(e.character.attack-s.character.defence,.1*e.character.attack));this.gamePlay.showDamage(s.position,i).then((()=>{s.character.health=Math.max(s.character.health-i,0),0!==s.character.health||(this.died(s),0!==this.gameState.playerAlive&&0!==this.gameState.rivalAlive)?(this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.passMove()):this.nextRound()}))}died(e){e.position===this.gameState.selectedIndex&&(this.gamePlay.deselectCell(this.gameState.selectedIndex),this.gameState.selectedIndex=-1),e.position===this.selectedRedIndex&&(this.gamePlay.deselectCell(this.selectedRedIndex),this.selectedRedIndex=-1),this.gameState.teams[0].has(e.character)?this.gameState.playerAlive-=1:this.gameState.rivalAlive-=1,this.gameState.positionedCharacters.splice(this.gameState.positionedCharacters.indexOf(e),1),this.gamePlay.redrawPositions(this.gameState.positionedCharacters)}getTargets(){return Array.from(this.cellsForAttack).filter((e=>{const t=Array.from(this.gameState.positionedCharacters).find((t=>t.position===e));return!!t&&this.gameState.teams[0].has(t.character)}))}passMove(){this.gameState.playerTurn=!this.gameState.playerTurn,this.gameState.playerTurn?this.onCellClick(this.gameState.selectedIndex):this.rivalTurn()}rivalTurn(){const e=Array.from(this.gameState.positionedCharacters).filter((e=>this.gameState.teams[1].has(e.character)));if(e.length>0){let t=null,a=0,s=[];for(let i=0;i<e.length;i+=1)this.getCellsForAttack(e[i]),s=this.getTargets(),s.length>0&&e[i].character.attack>a&&(a=e[i].character.attack,t=e[i]);if(t)this.getCellsForAttack(t),s=this.getTargets(),this.attack(t,s[f(0,s.length-1)]);else{t=null;let a=0;for(let s=0;s<e.length;s+=1)e[s].character.defence>a&&(a=e[s].character.defence,t=e[s]);t&&(this.getCellsForMove(t),this.moveCharacter(t.position,this.cellsForMove[f(0,this.cellsForMove.length-1)]))}}}onCellClick(e){if(!this.gameState.playerTurn||-1===e)return;const t=Array.from(this.gameState.positionedCharacters).find((t=>t.position===e));if(t)if(this.gameState.teams[0].has(t.character))-1!==this.gameState.selectedIndex&&this.gamePlay.deselectCell(this.gameState.selectedIndex),this.gamePlay.selectCell(e),this.gameState.selectedIndex=e,this.getCellsForMove(t),this.getCellsForAttack(t);else if(-1===this.gameState.selectedIndex)s.showError("–≠—Ç–æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂ –Ω–µ –∏–∑ –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã!");else if(-1===this.cellsForAttack.indexOf(e))s.showError("–ù–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞—Ç–∞–∫–∏!");else{const t=Array.from(this.gameState.positionedCharacters).find((e=>e.position===this.gameState.selectedIndex));this.attack(t,e)}else-1===this.selectedGreenIndex?s.showError("–°—é–¥–∞ –Ω–µ–ª—å–∑—è —Ö–æ–¥–∏—Ç—å!"):this.moveCharacter(this.gameState.selectedIndex,this.selectedGreenIndex)}onCellEnter(e){-1!==this.selectedGreenIndex&&this.gameState.selectedIndex!==this.selectedGreenIndex&&(this.gamePlay.deselectCell(this.selectedGreenIndex),this.selectedGreenIndex=-1),-1!==this.selectedRedIndex&&this.gameState.selectedIndex!==this.selectedRedIndex&&(this.gamePlay.deselectCell(this.selectedRedIndex),this.selectedRedIndex=-1);const t=Array.from(this.gameState.positionedCharacters).find((t=>t.position===e));t?(this.gameState.teams[0].has(t.character)?this.gamePlay.setCursor(g):this.gameState.teams[1].has(t.character)&&(-1!==this.cellsForAttack.indexOf(t.position)&&-1!==this.gameState.selectedIndex?(this.gamePlay.setCursor(u),this.gamePlay.selectCell(e,"red"),this.selectedRedIndex=e):this.gamePlay.setCursor(p)),this.gamePlay.showCellTooltip(t.character.getTooltip(),e)):-1!==this.gameState.selectedIndex&&-1!==this.cellsForMove.indexOf(e)?(this.gamePlay.setCursor(g),this.gamePlay.selectCell(e,"green"),this.selectedGreenIndex=e):this.gamePlay.setCursor(p)}onCellLeave(e){this.gamePlay.hideCellTooltip(e)}onNewGame(){this.gameOver(!1)}onSaveGame(){if(confirm("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É?")){try{this.stateService.save(this.gameState)}catch(e){return void s.showError(`–ò–≥—Ä–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏: ${e.message}`)}s.showMessage("–ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.")}}onLoadGame(){if(!confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∏–≥—Ä—É?"))return;let e=null;try{e=this.stateService.load()}catch(e){return void s.showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏: ${e.message}`)}this.selectedGreenIndex=-1,this.selectedRedIndex=-1,this.gameState.selectedIndex=-1,this.clearButtonsListeners(),this.clearMouseListeners(),this.addListeners(),this.gameState=C.from(e),this.gamePlay.drawUi(this.theme),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.onCellClick(this.gameState.selectedIndex)}}(w,y);x.init()}();